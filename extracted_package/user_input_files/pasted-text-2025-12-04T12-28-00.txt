#!/bin/bash

# Comprehensive Setup Script for JESECI Interactive Learning Platform
# Handles JaC compilation, Redis config, React dependencies, and environment setup

echo "ğŸš€ JESECI Interactive Learning Platform - Complete Setup"
echo "======================================================"

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

print_status() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

print_status "ğŸ”§ Starting comprehensive setup..."

# =============================================================================
# STEP 1: Backend Environment Setup
# =============================================================================
print_status "ğŸ“‹ Step 1: Backend setup and environment configuration..."

cd backend

# Create comprehensive .env file
print_status "Creating/updating .env file with complete configuration..."
cat > .env << 'EOF'
# Environment Variables for JESECI Interactive Learning Platform 
# Author: Cavin Otieno - cavin.otieno012@gmail.com

# =============================================================================
# SENTRY ERROR MONITORING - PRODUCTION READY
# =============================================================================

SENTRY_DSN_BACKEND=https://759a58b1fc0aee913b2cb184db7fd880@o4510403562307584.ingest.de.sentry.io/4510403573842000
REACT_APP_SENTRY_DSN=https://ef79ebd29c8a961b5d5dd6c313ccf7ba@o4510403562307584.ingest.de.sentry.io/4510403631054928

# =============================================================================
# APPLICATION CONFIGURATION
# =============================================================================

ENVIRONMENT=development
NODE_ENV=development
RELEASE_VERSION=1.0.0
REACT_APP_VERSION=2.1.0

# Django Secret Key (UPDATE FOR PRODUCTION!)
SECRET_KEY=django-insecure-jac-learning-platform-secret-key-for-development-only-2024

# =============================================================================
# DATABASE CONFIGURATION
# =============================================================================
DATABASE_URL=postgresql://jeseci_user:jeseci_password@localhost:5432/jeseci_db
DB_NAME=jeseci_db
DB_USER=jeseci_user
DB_PASSWORD=jeseci_password
DB_HOST=postgres
DB_PORT=5432

# Alternative: sqlite for development
DATABASE_URL=sqlite:///db.sqlite3

# =============================================================================
# CONTACT INFORMATION - CONSISTENT ACROSS PROJECT
# =============================================================================

AUTHOR_NAME=Cavin Otieno
AUTHOR_EMAIL=cavin.otieno012@gmail.com
AUTHOR_PHONE=+254708101604
AUTHOR_WHATSAPP=https://wa.me/254708101604
AUTHOR_LINKEDIN=https://www.linkedin.com/in/cavin-otieno-9a841260/
AUTHOR_GITHUB=OumaCavin

# WhatsApp Integration
WHATSAPP_API_URL=https://wa.me/254708101604
WHATSAPP_ENABLED=true

# Email Configuration (Consistent Author Email)
EMAIL_HOST_USER=cavin.otieno012@gmail.com
EMAIL_HOST_PASSWORD=oakjazoekos
EMAIL_FROM_NAME=Cavin Otieno
EMAIL_FROM_EMAIL=cavin.otieno012@gmail.com

# =============================================================================
# REDIS CONFIGURATION
# =============================================================================

# Redis Configuration - Password matches redis.conf
REDIS_PASSWORD=redis_password
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_URL=redis://localhost:6379/0

# =============================================================================
# JAC CODE EXECUTION CONFIGURATION
# =============================================================================

# Jac Server Configuration
JAC_SERVER_URL=http://localhost:8001
JAC_GRAPH_PATH=backend/jac_layer/main.jac
JAC_CONFIG_COMPILE_TIMEOUT=30
JAC_CONFIG_EXECUTION_TIMEOUT=60
JAC_CONFIG_MAX_MEMORY_MB=512
JAC_CONFIG_LOG_LEVEL=DEBUG

#Jac Execution Configuration
JAC_EXECUTION_TIMEOUT=30
JAC_EXECUTION_MEMORY_LIMIT=128
JAC_MAX_CODE_SIZE=10240
DOCKER_SANDBOX_ENABLED=True
DOCKER_SANDBOX_NETWORK=jac_internal

# LLM API Keys (Required for byLLM features)
OPENAI_API_KEY=your-openai-api-key-here
GEMINI_API_KEY=your-gemini-api-key-here
LLM_PROVIDER=openai  # Options: openai, gemini

# =============================================================================
# CELERY CONFIGURATION
# =============================================================================

CELERY_BROKER_URL=redis://:redis_password@localhost:6379/1
CELERY_RESULT_BACKEND=redis://:redis_password@localhost:6379/2

# =============================================================================
# CORS CONFIGURATION
# =============================================================================

CORS_ALLOWED_ORIGINS=http://localhost:3000,http://127.0.0.1:3000
CORS_ALLOW_CREDENTIALS=True

# File Upload Configuration
MAX_UPLOAD_SIZE=10485760  # 10MB

# Logging Configuration
LOG_LEVEL=INFO

# Security Configuration
SECURE_SSL_REDIRECT=False  # Set to True in production
SESSION_COOKIE_SECURE=False  # Set to True in production
CSRF_COOKIE_SECURE=False  # Set to True in production

# =============================================================================
# EMAIL CONFIGURATION
# =============================================================================

EMAIL_BACKEND=django.core.mail.backends.console.EmailBackend
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_USE_TLS=True
EMAIL_HOST_USER=cavin.otieno012@gmail.com
EMAIL_HOST_PASSWORD=oakjazoekos

# =============================================================================
# CODEBASE GENIUS CONFIGURATION
# =============================================================================

GITHUB_TOKEN=your-github-token-for-repo-cloning
DOCS_OUTPUT_PATH=docs/generated

# =============================================================================
# MONITORING & ANALYTICS
# =============================================================================

SENTRY_DSN=your-sentry-dsn-here
GOOGLE_ANALYTICS_ID=your-ga-id-here

# =============================================================================
# JAC LANGUAGE SETTINGS
# =============================================================================

JAC_LANGUAGE_PATH=backend/jac_layer/walkers

# =============================================================================
# SECURITY SETTINGS
# =============================================================================

JWT_ACCESS_TOKEN_LIFETIME=60
JWT_REFRESH_TOKEN_LIFETIME=10080
JWT_ALGORITHM=HS256
RATELIMIT_USE_CACHE=default
DEFAULT_THROTTLE_RATES_ANON=100/hour
DEFAULT_THROTTLE_RATES_USER=1000/hour

# =============================================================================
# MONITORING AND PERFORMANCE
# =============================================================================

SENTRY_TRACES_SAMPLE_RATE=0.1
SENTRY_PROFILES_SAMPLE_RATE=0.0
SENTRY_LOG_LEVEL=INFO
HEALTH_CHECK_ENABLED=True
HEALTH_CHECK_DATABASE=True
HEALTH_CHECK_REDIS=True
HEALTH_CHECK_STORAGE=True

# =============================================================================
# EXTERNAL APIs - CONSISTENT TOKENS
# =============================================================================

# Google AI API (Maker Suite) - Active
GOOGLE_API_KEY=AIzaSyB3OhghL8KcNaixdZkM4Wfd07_dAoQvrI0

# GitHub Personal Access Token (Fine-Grained) - Active
GITHUB_PAT=your_github_pat_token_here

# =============================================================================
# AGENT SYSTEM CONFIGURATION
# =============================================================================

AGENT_COORDINATION_TIMEOUT=10
AGENT_TASK_TIMEOUT=300
AGENT_MAX_CONCURRENT_TASKS=5

CONTENT_CURATOR_CACHE_TIMEOUT=1800
QUIZ_MASTER_CACHE_TIMEOUT=900
EVALUATOR_CACHE_TIMEOUT=600
PROGRESS_TRACKER_CACHE_TIMEOUT=300
MOTIVATOR_CACHE_TIMEOUT=1800

# =============================================================================
# KNOWLEDGE GRAPH CONFIGURATION
# =============================================================================

KNOWLEDGE_GRAPH_MAX_NODES=1000
KNOWLEDGE_GRAPH_MAX_EDGES=5000
KNOWLEDGE_GRAPH_CACHE_TIMEOUT=3600

# =============================================================================
# DEVELOPMENT OVERRIDES
# =============================================================================

ALLOW_SELF_REGISTRATION=True
DEVELOPMENT_MODE=True
EOF

print_success "âœ… Created comprehensive .env file with Redis password"

# Load environment variables
print_status "Loading environment variables..."
export $(grep -v '^#' .env | xargs)

# Install jaclang if not present
print_status "Installing/updating jaclang 0.9.3..."
pip install jaclang[all]==0.9.3 2>/dev/null || pip install jaclang[all]
print_success "âœ… jaclang installed"

# =============================================================================
# STEP 2: JaC Walker Compilation (Critical Fix)
# =============================================================================
print_status "ğŸ—ï¸  Step 2: Compiling JaC walker files (resolving bytecode issues)..."

# Set Python path for Django
export PYTHONPATH="${PWD}:${PYTHONPATH}"

# Compile JaC walkers using multiple fallback strategies
print_status "Strategy 1: Directory compilation..."
if jac build jac_layer/walkers/ 2>/dev/null; then
    print_success "âœ… Successfully compiled walkers using directory compilation"
else
    print_warning "Directory compilation failed, trying individual files..."
    
    # Strategy 2: Individual file compilation
    for walker in jac_layer/walkers/*.jac; do
        if [[ -f "$walker" ]]; then
            filename=$(basename "$walker")
            print_status "ğŸ“ Compiling $filename..."
            if jac build "$walker" 2>/dev/null; then
                print_success "âœ… Compiled $filename"
            else
                print_warning "âš ï¸  Could not compile $filename (will use fallback)"
            fi
        fi
    done
    
    # Strategy 3: Main graph compilation
    if [[ -f "jac_layer/main.jac" ]]; then
        print_status "Compiling main.jac..."
        if jac build jac_layer/main.jac 2>/dev/null; then
            print_success "âœ… Compiled main.jac"
        else
            print_warning "âš ï¸  Could not compile main.jac (will use fallback)"
        fi
    fi
fi

print_status "ğŸ” Checking compiled files..."
find . -name "*.jac.py" -o -name "__pycache__" -type d 2>/dev/null | head -5

# =============================================================================
# STEP 3: Django Management Commands
# =============================================================================
print_status "ğŸ—‚ï¸  Step 3: Running Django management commands..."

# Ensure migrations exist
python manage.py makemigrations 2>/dev/null || print_warning "âš ï¸  No new migrations needed"

# Run migrations
python manage.py migrate 2>/dev/null || print_warning "âš ï¸  Migration issues (may be normal for development)"

# Initialize JaC walkers (this uses the enhanced fallback system)
print_status "Initializing JaC walkers with fallback system..."
if python manage.py init_jac_walkers; then
    print_success "âœ… JaC walkers initialized successfully"
else
    print_warning "âš ï¸  JaC walker initialization had issues (will use fallback execution)"
fi

# Test JaC integration
print_status "Testing JaC integration..."
if python manage.py test_jac_integration; then
    print_success "âœ… JaC integration test passed"
else
    print_warning "âš ï¸  JaC integration test had issues"
fi

# =============================================================================
# STEP 4: Redis Configuration Test
# =============================================================================
print_status "ğŸ”´ Step 4: Testing Redis configuration..."

if [ -n "$REDIS_PASSWORD" ]; then
    print_success "âœ… Redis password configured: redis_password"
    
    # Test Redis CLI connection
    if command -v redis-cli >/dev/null 2>&1; then
        if redis-cli -a "$REDIS_PASSWORD" ping 2>/dev/null; then
            print_success "âœ… Redis CLI connection successful"
        else
            print_warning "âš ï¸  Redis CLI connection failed - ensure Redis is running"
        fi
    else
        print_warning "âš ï¸  redis-cli not found"
    fi
    
    # Test Python Redis connection
    python -c "
import redis
import os
try:
    r = redis.Redis(host='localhost', port=6379, password='$REDIS_PASSWORD', decode_responses=True)
    result = r.ping()
    print('âœ… Python Redis connection successful')
except Exception as e:
    print(f'âš ï¸  Python Redis connection failed: {e}')
    print('Note: This is normal if Redis is not running yet')
" 2>/dev/null
else
    print_warning "âš ï¸  No Redis password configured"
fi

cd ..

# =============================================================================
# STEP 5: Frontend Setup and React Dependency Fix
# =============================================================================
print_status "ğŸ¨ Step 5: Frontend setup and React dependency fix..."

cd frontend

# Fix React version conflicts
if [ ! -d "node_modules" ] || [ ! -f "package-lock.json" ]; then
    print_status "Installing React dependencies with version fix..."
    
    # Clean install
    rm -rf node_modules package-lock.json 2>/dev/null
    
    # Install React 18 explicitly to prevent version conflicts
    npm install react@^18.2.0 react-dom@^18.2.0 @types/react@^18.2.0 @types/react-dom@^18.2.0 --save
    
    # Install remaining dependencies
    npm install
    
    print_success "âœ… Frontend dependencies installed with React 18"
else
    print_success "âœ… Frontend dependencies already installed"
fi

# Check React version
print_status "React version verification:"
npm list react react-dom 2>/dev/null | grep react || print_warning "Could not verify React versions (normal for development)"

cd ..

# =============================================================================
# STEP 6: Create Startup Scripts
# =============================================================================
print_status "ğŸ“ Step 6: Creating startup scripts..."

# Create start_backend.sh
cat > start_backend.sh << 'EOF'
#!/bin/bash
echo "ğŸš€ Starting Django Backend Server..."
cd backend
source .env
echo "Backend will be available at: http://localhost:8000"
echo "API available at: http://localhost:8000/api/"
echo "Admin panel at: http://localhost:8000/admin/"
python manage.py runserver 0.0.0.0:8000
EOF

# Create start_celery.sh with JaC initialization
cat > start_celery.sh << 'EOF'
#!/bin/bash
echo "ğŸ”„ Starting Celery Worker..."
cd backend
source .env

# Initialize JaC walkers before starting Celery
echo "Initializing JaC walkers..."
python manage.py init_jac_walkers

# Test Redis connection
echo "Testing Redis connection..."
python -c "
import redis
import os
try:
    r = redis.Redis(host='localhost', port=6379, password='$REDIS_PASSWORD', decode_responses=True)
    r.ping()
    print('âœ… Redis connection successful')
except Exception as e:
    print(f'âš ï¸  Redis connection issue: {e}')
    print('Note: Celery will retry connection')
"

echo "Starting Celery worker..."
celery -A jeseci_platform worker --loglevel=info
EOF

# Create start_frontend.sh
cat > start_frontend.sh << 'EOF'
#!/bin/bash
echo "ğŸ¨ Starting React Frontend..."
cd frontend
echo "Frontend will be available at: http://localhost:3000"
npm start
EOF

# Make scripts executable
chmod +x start_backend.sh start_celery.sh start_frontend.sh
print_success "âœ… Startup scripts created and made executable"

# =============================================================================
# STEP 7: Final Validation and Status Report
# =============================================================================
print_status "ğŸ§ª Step 7: Final validation..."

cd backend

# Check JaC walker status
print_status "Checking JaC walker status..."
python manage.py shell -c "
from jac_layer.jac_manager import jac_manager
try:
    walkers = jac_manager.get_available_walkers()
    loaded_count = sum(1 for info in walkers.values() if info['loaded'])
    total_count = len(walkers)
    print(f'ğŸ“Š Loaded {loaded_count}/{total_count} walkers successfully')
    for name, info in walkers.items():
        status = 'âœ…' if info['loaded'] else 'âŒ'
        print(f'  {status} {name}')
    
    if loaded_count > 0:
        print('âœ… JaC system is operational')
    else:
        print('âš ï¸  No walkers loaded - will use fallback execution')
except Exception as e:
    print(f'âš ï¸  Error checking walkers: {e}')
    print('JaC system will use fallback execution mode')
" 2>/dev/null

# Test Redis one more time
print_status "Final Redis test..."
python -c "
import redis
import os
try:
    r = redis.Redis(host='localhost', port=6379, password='redis_password', decode_responses=True)
    result = r.ping()
    print('âœ… Redis is ready for Celery')
except Exception as e:
    print('âš ï¸  Redis not ready - start Redis with: sudo systemctl start redis')
" 2>/dev/null

cd ..

# =============================================================================
# COMPLETION MESSAGE
# =============================================================================
echo ""
print_success "ğŸ‰ Setup completed successfully!"
echo ""
echo "ğŸ“‹ Setup Summary:"
echo "âœ… Backend environment configured with comprehensive .env file"
echo "âœ… Redis password configured: redis_password"
echo "âœ… JaC walker files compiled with multiple fallback strategies"  
echo "âœ… Django management commands executed"
echo "âœ… Frontend React dependencies fixed (React 18.2.0)"
echo "âœ… Startup scripts created for easy launching"
echo ""
echo "ğŸš€ NEXT STEPS:"
echo "Open 4 terminal windows and run these commands:"
echo ""
echo "Terminal 1 - Backend:"
echo "  cd ~/projects/Jeseci-Interactive-Learning-Platform"
echo "  ./start_backend.sh"
echo ""
echo "Terminal 2 - Celery Worker:"
echo "  cd ~/projects/Jeseci-Interactive-Learning-Platform" 
echo "  ./start_celery.sh"
echo ""
echo "Terminal 3 - Frontend:"
echo "  cd ~/projects/Jeseci-Interactive-Learning-Platform"
echo "  ./start_frontend.sh"
echo ""
echo "ğŸ”— Access Points:"
echo "  â€¢ Frontend: http://localhost:3000"
echo "  â€¢ Backend API: http://localhost:8000/api/"
echo "  â€¢ Admin Panel: http://localhost:8000/admin/"
echo ""
echo "ğŸ” If you encounter issues:"
echo "  â€¢ Check Redis: sudo systemctl status redis"
echo "  â€¢ View logs in each terminal"
echo "  â€¢ JaC walkers have fallback execution if compilation fails"
echo "  â€¢ React 18.2.0 prevents version conflicts"
echo ""
print_success "Your Multi-Agent Learning Platform is ready! ğŸš€"
echo ""
echo "Note: If JaC walker warnings appear, the system will use"
echo "fallback execution to ensure functionality."